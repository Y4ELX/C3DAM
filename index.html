<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Cámara 3D Estilo iOS v2</title>
  <style>
    /* Reset y Estilos Base */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
        height: -webkit-fill-available; /* Soporte extra para iOS */
    }

    body {
      /* Usa dvh para altura dinámica que considera UI del navegador */
      height: 100dvh;
      /* Fallback para navegadores que no soporten dvh */
      min-height: -webkit-fill-available;
      overflow: hidden; /* Evitar scroll general */
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      display: flex;
      flex-direction: column;
      background-color: #000;
      color: #fff;
    }

    /* Contenedor principal para video y flash */
    .viewport-container {
        position: relative; /* Para posicionar el flash overlay */
        flex-grow: 1; /* Ocupa el espacio restante */
        overflow: hidden; /* Contener video/flash */
        display: flex; /* Centrar video si es necesario */
        background-color: #000; /* Fondo si el video no carga */
    }

    /* Visor de la cámara */
    #video {
      width: 100%;
      height: 100%;
      object-fit: cover; /* Cubre el área sin distorsión */
      display: block;
      z-index: 1; /* Debajo del flash */
    }

    /* --- Efecto Flash --- */
    #flashOverlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: white;
        opacity: 0;
        pointer-events: none; /* No interfiere con clics */
        z-index: 5; /* Encima del video, debajo de controles/modal */
        display: none; /* Oculto hasta que se activa */
    }

    /* Animación del flash */
    @keyframes flashAnimation {
        0% { opacity: 0; }
        50% { opacity: 0.7; } /* Pico del flash */
        100% { opacity: 0; }
    }

    /* Clase para activar la animación */
    #flashOverlay.flash {
        display: block; /* Hacer visible para animar */
        animation: flashAnimation 0.3s ease-in-out; /* Duración y timing */
    }

    /* Contenedor de controles inferior */
    #controls-container {
      background-color: #000;
      padding: 15px 20px; /* Ajuste ligero de padding */
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
      flex-shrink: 0;
      z-index: 10; /* Encima del video y flash */
      position: relative; /* Asegura z-index */
    }

    #progress {
      margin-bottom: 15px;
      font-size: 0.9em;
      color: #ccc;
      text-align: center;
      min-height: 2.5em;
      line-height: 1.4;
    }

    /* Estilos de botones */
    button {
      background: none;
      border: none;
      color: #fff;
      cursor: pointer;
      font-size: 1em;
      margin: 5px 0;
      padding: 10px 15px;
      border-radius: 8px;
    }

    #startBtn {
      background-color: #333;
      padding: 12px 25px;
      font-weight: bold;
    }

    #takeFirstPhoto, #takeSecondPhoto {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background-color: rgba(255, 255, 255, 0.9);
      border: 4px solid #fff;
      padding: 0;
      margin: 10px 0;
      position: relative;
    }

    #takeFirstPhoto:active, #takeSecondPhoto:active {
        background-color: rgba(200, 200, 200, 0.9);
    }

    #canvas { display: none; }
    #photoPreview { display: none; }

    /* --- Estilos del Modal (Rediseñado) --- */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100dvh; /* Usar dvh también aquí */
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.8); /* Un poco más oscuro */
      justify-content: center;
      align-items: center;
      padding: 15px; /* Espacio alrededor del contenido */
    }

    .modal-content {
      background-color: #282828; /* Fondo oscuro para el modal */
      color: #fff; /* Texto blanco en modal */
      margin: auto;
      padding: 25px; /* Padding uniforme */
      width: auto;
      max-width: 90%;
      max-height: 90dvh; /* Límite de altura */
      position: relative;
      border-radius: 12px; /* Bordes más redondeados */
      box-shadow: 0 8px 25px rgba(0,0,0,0.5);
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .modal-content img {
      display: block;
      max-width: 100%;
      /* Ajusta max-height considerando padding y espacio para botón */
      max-height: calc(90dvh - 150px);
      height: auto;
      margin-bottom: 20px; /* Espacio antes del botón */
      border-radius: 6px; /* Bordes redondeados para la imagen */
    }

    .close-btn {
      color: #ccc; /* Color más visible en fondo oscuro */
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 30px;
      font-weight: bold;
      cursor: pointer;
      line-height: 1;
    }

    .close-btn:hover,
    .close-btn:focus {
      color: #fff;
    }

    #saveBtn {
      background-color: #007AFF;
      color: white;
      padding: 12px 25px; /* Botón más grande */
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1em;
      font-weight: bold;
      margin-top: 10px; /* Espacio sobre el botón */
      /* Ya no es absoluto, se alinea con flex */
    }

    #saveBtn:hover {
      background-color: #005ecb;
    }

  </style>
</head>
<body>

<div class="viewport-container">
    <video id="video" autoplay muted playsinline></video>
    <div id="flashOverlay"></div> </div>

<canvas id="canvas"></canvas>

<div id="controls-container">
  <div id="progress"></div>
  <button id="startBtn">Iniciar Cámara</button>
  <button id="takeFirstPhoto" style="display:none;"></button>
  <button id="takeSecondPhoto" style="display:none;"></button>
</div>

<div id="photoPreview"></div>

<div id="polaroidModal" class="modal">
  <div class="modal-content">
    <span id="closeModalBtn" class="close-btn">&times;</span>
    <img id="polaroidImage" src="" alt="Foto 3D Generada">
    <button id="saveBtn">Guardar Foto</button>
  </div>
</div>


<script>
  let firstImageData = null;
  let stream = null;

  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const progress = document.getElementById('progress');
  const startBtn = document.getElementById('startBtn');
  const takeFirstPhotoBtn = document.getElementById('takeFirstPhoto');
  const takeSecondPhotoBtn = document.getElementById('takeSecondPhoto');
  const polaroidModal = document.getElementById('polaroidModal');
  const polaroidImage = document.getElementById('polaroidImage');
  const closeModalBtn = document.getElementById('closeModalBtn');
  const saveBtn = document.getElementById('saveBtn');
  const controlsContainer = document.getElementById('controls-container');
  const flashOverlay = document.getElementById('flashOverlay'); // Referencia al overlay

  // Función para activar el flash
  function triggerFlash() {
      flashOverlay.classList.add('flash');
  }

  // Listener para limpiar la clase de flash cuando termina la animación
  flashOverlay.addEventListener('animationend', () => {
      flashOverlay.classList.remove('flash');
      flashOverlay.style.display = 'none'; // Asegura que se oculte
  });


  // Iniciar cámara
  function startCamera() {
    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
      .then(mediaStream => {
        stream = mediaStream;
        video.srcObject = stream;
        video.style.display = 'block';
        startBtn.style.display = 'none';
        takeFirstPhotoBtn.style.display = 'block';
        takeSecondPhotoBtn.style.display = 'none';
        controlsContainer.style.display = 'flex';
        progress.innerText = "Toma la primera foto";
      })
      .catch(err => {
        console.error('Error al acceder a la cámara:', err);
        alert('No se pudo acceder a la cámara: ' + err.message);
        resetUI();
      });
  }

  // Detener cámara
  function stopCamera() {
      if (stream) {
          stream.getTracks().forEach(track => track.stop());
          stream = null;
          video.srcObject = null;
          console.log("Cámara detenida");
      }
  }

  // Tomar foto (ahora sin trigger flash aquí)
  function takePhoto() {
    const ctx = canvas.getContext('2d');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    return canvas.toDataURL('image/jpeg');
  }

  function requestPermissionAndStart() {
    startCamera();
  }

  function resetUI() {
      stopCamera();
      video.style.display = 'block';
      startBtn.style.display = 'block';
      takeFirstPhotoBtn.style.display = 'none';
      takeSecondPhotoBtn.style.display = 'none';
      progress.innerText = '';
      polaroidModal.style.display = 'none';
      controlsContainer.style.display = 'flex';
      firstImageData = null;
      flashOverlay.style.display = 'none'; // Asegurar que el flash esté oculto
      flashOverlay.classList.remove('flash'); // Quitar clase por si acaso
  }

  // --- Event Listeners ---
  startBtn.onclick = requestPermissionAndStart;

  takeFirstPhotoBtn.onclick = () => {
    triggerFlash(); // Activar flash
    // Pequeña demora opcional para que el flash se vea antes de procesar
    // setTimeout(() => {
        firstImageData = takePhoto();
        progress.innerText = "¡OK! Ahora mueve el móvil ~5cm a la derecha y toma la segunda foto.";
        takeFirstPhotoBtn.style.display = 'none';
        takeSecondPhotoBtn.style.display = 'block';
    // }, 50); // 50ms de demora (ajustar si es necesario)
  };

  takeSecondPhotoBtn.onclick = () => {
    triggerFlash(); // Activar flash
    // setTimeout(() => {
        const secondImageData = takePhoto();
        progress.innerText = "Procesando...";

        const img1 = new Image();
        const img2 = new Image();

        img1.onload = () => {
          img2.onload = () => {
            const combinedCanvas = document.createElement('canvas');
            const combinedCtx = combinedCanvas.getContext('2d');

            combinedCanvas.width = img1.width + img2.width;
            combinedCanvas.height = Math.max(img1.height, img2.height);

            combinedCtx.drawImage(img1, 0, 0);
            combinedCtx.drawImage(img2, img1.width, 0);

            const combinedImageURL = combinedCanvas.toDataURL('image/jpeg');

            polaroidImage.src = combinedImageURL;
            polaroidModal.style.display = 'flex';

            progress.innerText = '';
            takeSecondPhotoBtn.style.display = 'none';

          };
          img2.src = secondImageData;
        };
        img1.src = firstImageData;
    // }, 50);
  };

  closeModalBtn.onclick = () => {
    resetUI();
  };

  window.onclick = (event) => {
    if (event.target == polaroidModal) {
       resetUI();
    }
  };

  saveBtn.onclick = () => {
    const link = document.createElement('a');
    link.href = polaroidImage.src;
    link.download = 'foto-3d.jpg'; // Nombre de archivo simplificado
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  };

  // Inicializar UI al cargar
  resetUI();

</script>

</body>
</html>