<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Foto 3D</title>
  <style>
    video, canvas {
      width: 100%;
      max-width: 400px;
      margin-bottom: 10px;
    }
    #progress {
      margin: 10px 0;
      font-size: 18px;
    }
    #takeSecondPhoto {
      display: none;
    }

    /* Animación para mostrar las imágenes con suavidad */
    .image-container {
      opacity: 0;
      transition: opacity 1s ease-in-out;
    }

    .image-container.show {
      opacity: 1;
    }

    .image-container img {
      width: 100%;
      max-width: 400px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
    }

    /* Animación de la foto */
    #canvas {
      display: none;
    }
  </style>
</head>
<body>

<video id="video" autoplay muted playsinline></video>
<canvas id="canvas"></canvas>

<div id="progress"></div>

<button id="startBtn">Iniciar Cámara</button>
<button id="takeFirstPhoto" style="display:none;">Tomar Primera Foto</button>
<button id="takeSecondPhoto" style="display:none;">Tomar Segunda Foto</button>

<div id="photoPreview" class="image-container"></div>

<script>
let firstImageData = null;

// Iniciar cámara
function startCamera() {
  navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
    .then(stream => {
      const video = document.getElementById('video');
      video.srcObject = stream;
    })
    .catch(err => {
      alert('No se pudo acceder a la cámara: ' + err.message);
    });
}

// Tomar foto
function takePhoto() {
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  return canvas.toDataURL('image/jpeg');
}

// Solicitar permiso en iPhone
function requestPermission() {
  if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
    DeviceOrientationEvent.requestPermission()
      .then(response => {
        if (response === 'granted') {
          startCamera();
          document.getElementById('startBtn').style.display = 'none';
          document.getElementById('takeFirstPhoto').style.display = 'block';
        } else {
          alert('Permiso denegado');
        }
      })
      .catch(console.error);
  } else {
    // Android no necesita pedir permiso
    startCamera();
    document.getElementById('startBtn').style.display = 'none';
    document.getElementById('takeFirstPhoto').style.display = 'block';
  }
}

document.getElementById('startBtn').onclick = requestPermission;

document.getElementById('takeFirstPhoto').onclick = () => {
  firstImageData = takePhoto();
  document.getElementById('progress').innerText = "¡Ahora mueve el celular aproximadamente 5 cm a la derecha y toma la segunda foto!";
  document.getElementById('takeFirstPhoto').style.display = 'none';
  document.getElementById('takeSecondPhoto').style.display = 'block';
};

document.getElementById('takeSecondPhoto').onclick = () => {
  const secondImageData = takePhoto();

  // Mostrar la previsualización de las fotos
  const photoPreview = document.getElementById('photoPreview');
  photoPreview.classList.add('show');  // Activar animación

  const img1 = new Image();
  const img2 = new Image();

  img1.onload = () => {
    img2.onload = () => {
      const combinedCanvas = document.createElement('canvas');
      const combinedCtx = combinedCanvas.getContext('2d');

      combinedCanvas.width = img1.width + img2.width;
      combinedCanvas.height = img1.height;

      combinedCtx.drawImage(img1, 0, 0);
      combinedCtx.drawImage(img2, img1.width, 0);

      const combinedImage = combinedCanvas.toDataURL('image/jpeg');
      const finalImg = new Image();
      finalImg.src = combinedImage;
      photoPreview.innerHTML = '';  // Limpiar el contenedor antes de agregar la nueva imagen
      photoPreview.appendChild(finalImg);
    };
    img2.src = secondImageData;
  };
  img1.src = firstImageData;
};
</script>

</body>
</html>
