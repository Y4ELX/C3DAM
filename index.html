<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Foto 3D</title>
  <style>
    video, canvas {
      width: 100%;
      max-width: 400px;
      margin-bottom: 10px;
    }
    #progress {
      margin: 10px 0;
    }
  </style>
</head>
<body>

<video id="video" autoplay muted playsinline></video>
<canvas id="canvas" style="display:none;"></canvas>

<div id="progress"></div>

<button id="startBtn">Iniciar Cámara</button>
<button id="takeFirstPhoto" style="display:none;">Tomar Primera Foto</button>
<button id="takeSecondPhoto" style="display:none;">Tomar Segunda Foto</button>

<script>
let firstImageData = null;
let startTracking = false;
let initialX = null;  // Posición inicial del dispositivo
let velocity = 0;  // Velocidad acumulada
let displacement = 0;  // Desplazamiento acumulado
let previousAcceleration = 0;  // Aceleración anterior para detectar cambios

const smoothingFactor = 0.1;  // Factor para suavizar el ruido (puedes ajustarlo)

// Iniciar cámara
function startCamera() {
  navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
    .then(stream => {
      const video = document.getElementById('video');
      video.srcObject = stream;
    })
    .catch(err => {
      alert('No se pudo acceder a la cámara: ' + err.message);
    });
}

// Tomar foto
function takePhoto() {
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  return canvas.toDataURL('image/jpeg');
}

// Solicitar permiso en iPhone
function requestPermission() {
  if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
    DeviceOrientationEvent.requestPermission()
      .then(response => {
        if (response === 'granted') {
          startCamera();
          document.getElementById('startBtn').style.display = 'none';
          document.getElementById('takeFirstPhoto').style.display = 'block';
        } else {
          alert('Permiso denegado');
        }
      })
      .catch(console.error);
  } else {
    // Android no necesita pedir permiso
    startCamera();
    document.getElementById('startBtn').style.display = 'none';
    document.getElementById('takeFirstPhoto').style.display = 'block';
  }
}

document.getElementById('startBtn').onclick = requestPermission;

document.getElementById('takeFirstPhoto').onclick = () => {
  firstImageData = takePhoto();
  startTracking = true;
  velocity = 0;
  displacement = 0;
  document.getElementById('progress').innerText = "Ahora mueve ligeramente el teléfono a la derecha...";
  document.getElementById('takeFirstPhoto').style.display = 'none';
};

// Detectar aceleración y movimiento lineal
window.addEventListener('devicemotion', (event) => {
  if (!startTracking) return;

  // Obtener aceleración horizontal (en el eje X)
  const accelerationX = event.accelerationIncludingGravity.x;

  // Filtrar el ruido usando un suavizado
  const filteredAcceleration = smoothingFactor * accelerationX + (1 - smoothingFactor) * previousAcceleration;

  // Calcular velocidad acumulada
  velocity += filteredAcceleration;  // Integración de aceleración para obtener velocidad

  // Calcular desplazamiento acumulado
  displacement += velocity;  // Integración de velocidad para obtener desplazamiento

  // Mostrar el movimiento acumulado en la interfaz
  document.getElementById('progress').innerText = `Movimiento detectado: ${Math.abs(displacement).toFixed(2)} unidades`;

  // Si el desplazamiento es suficiente (ajustamos el umbral)
  if (Math.abs(displacement) > 30) {  // Aquí puedes ajustar el valor para que sea más preciso
    startTracking = false;
    document.getElementById('progress').innerText = "¡Listo! Ahora toma la segunda foto.";
    document.getElementById('takeSecondPhoto').style.display = 'block';
  }

  // Guardamos la aceleración filtrada para la siguiente iteración
  previousAcceleration = filteredAcceleration;
});

document.getElementById('takeSecondPhoto').onclick = () => {
  const secondImageData = takePhoto();

  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');

  const img1 = new Image();
  const img2 = new Image();

  img1.onload = () => {
    img2.onload = () => {
      canvas.width = img1.width + img2.width;
      canvas.height = img1.height;
      ctx.drawImage(img1, 0, 0);
      ctx.drawImage(img2, img1.width, 0);
      canvas.style.display = 'block';
      document.getElementById('video').style.display = 'none';
      document.getElementById('takeSecondPhoto').style.display = 'none';
      document.getElementById('progress').innerText = "¡Estereograma creado!";
    };
    img2.src = secondImageData;
  };
  img1.src = firstImageData;
};
</script>

</body>
</html>
