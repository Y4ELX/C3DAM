<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Foto 3D</title>
  <style>
    video, canvas {
      width: 100%;
      max-width: 400px;
      margin-bottom: 10px;
    }
    #progress {
      margin: 10px 0;
    }
  </style>
</head>
<body>

<video id="video" autoplay muted playsinline></video>
<canvas id="canvas" style="display:none;"></canvas>

<div id="progress"></div>

<button id="takeFirstPhoto">Tomar Primera Foto</button>
<button id="takeSecondPhoto" style="display:none;">Tomar Segunda Foto</button>

<script>
let firstImageData = null;
let startTracking = false;
let movement = 0;
let lastTimestamp = null;

// Iniciar cámara
function startCamera() {
  navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
    .then(stream => {
      const video = document.getElementById('video');
      video.srcObject = stream;
    })
    .catch(err => {
      alert('No se pudo acceder a la cámara: ' + err.message);
    });
}

// Tomar foto
function takePhoto() {
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  return canvas.toDataURL('image/jpeg');
}

document.getElementById('takeFirstPhoto').onclick = () => {
  firstImageData = takePhoto();
  document.getElementById('progress').innerText = "Ahora mueve el teléfono 5cm a la derecha...";
  startTracking = true;
  movement = 0;
  lastTimestamp = null;
  document.getElementById('takeFirstPhoto').style.display = 'none';
};

// Escuchar movimiento lineal
window.addEventListener('devicemotion', (event) => {
  if (!startTracking) return;

  if (lastTimestamp === null) {
    lastTimestamp = event.timeStamp;
    return;
  }

  const dt = (event.timeStamp - lastTimestamp) / 1000; // tiempo en segundos
  lastTimestamp = event.timeStamp;

  // aceleración en el eje X (izquierda-derecha)
  const ax = event.accelerationIncludingGravity.x || 0;

  // integrar aceleración para estimar distancia (distancia ≈ aceleración × tiempo²)
  movement += ax * dt * dt * 500; // el factor 500 es para amplificar y compensar la baja aceleración

  document.getElementById('progress').innerText = `Movido aprox: ${movement.toFixed(2)} cm`;

  if (Math.abs(movement) >= 5) { // si movió 5cm o más
    startTracking = false;
    document.getElementById('progress').innerText = "¡Listo! Ahora toma la segunda foto.";
    document.getElementById('takeSecondPhoto').style.display = 'block';
  }
});

document.getElementById('takeSecondPhoto').onclick = () => {
  const secondImageData = takePhoto();

  // Unir imágenes
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');

  const img1 = new Image();
  const img2 = new Image();

  img1.onload = () => {
    img2.onload = () => {
      canvas.width = img1.width + img2.width;
      canvas.height = img1.height;
      ctx.drawImage(img1, 0, 0);
      ctx.drawImage(img2, img1.width, 0);
      canvas.style.display = 'block';
      document.getElementById('video').style.display = 'none';
      document.getElementById('takeSecondPhoto').style.display = 'none';
      document.getElementById('progress').innerText = "¡Estereograma creado!";
    };
    img2.src = secondImageData;
  };
  img1.src = firstImageData;
};

startCamera();
</script>

</body>
</html>
